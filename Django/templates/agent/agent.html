{% extends "base.html" %}
{% load static %}

{% block title %}Agent{% endblock %}

{% block content %}
<div class="flex gap-6" style="height:80vh; min-height:560px; max-height:90vh;">
  <aside class="w-1/3 bg-white rounded shadow p-4" style="overflow-y:auto; max-height:100%;">
    <h2 class="text-lg font-semibold mb-3">Conversaciones</h2>

    <form method="get" class="mb-3">
      <label class="block text-sm text-gray-600 mb-1">Cliente</label>
      <select name="client" class="w-full border rounded px-2 py-1" onchange="this.form.submit()">
        <option value="">Todas</option>
        {% for c in clients %}
          <option value="{{ c.id }}" {% if selected_client and selected_client.id == c.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <div class="mt-2 text-xs">
        <a href="{% url 'client:list' %}" class="text-blue-600 hover:underline">Gestionar clientes y documentos</a>
      </div>
    </form>

    <div class="mb-4 flex gap-2">
      <form method="post" class="flex-1">
        {% csrf_token %}
        <input name="new_title" placeholder="Nueva conversación" class="w-full border rounded px-2 py-1" />
        {% if selected_client %}
          <input type="hidden" name="client_id" value="{{ selected_client.id }}" />
        {% endif %}
      </form>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="start_new" value="1" />
        {% if selected_client %}
          <input type="hidden" name="client_id" value="{{ selected_client.id }}" />
        {% endif %}
        <button type="submit" class="btn btn-sm btn-ghost">Nuevo agent</button>
      </form>
    </div>

    <ul>
      {% for conv in conversations %}
        <li class="mb-2">
          <a href="{% url 'agent:detail' conv.pk %}" class="block p-2 rounded hover:bg-gray-100 {% if conversation and conversation.pk == conv.pk %}bg-gray-100 font-medium{% endif %}">
            {{ conv.name|default:"(sin título)" }}
            <div class="text-xs text-gray-500">Últ: {{ conv.updated_at|date:"Y-m-d H:i" }}</div>
          </a>
        </li>
      {% empty %}
        <li class="text-sm text-gray-500">No hay agentes.</li>
      {% endfor %}
    </ul>
  </aside>

  <section class="flex-1 bg-white rounded shadow p-4 flex flex-col min-h-0 overflow-y-auto">
    {% if conversation %}
      <header class="mb-4">
        <h3 class="text-xl font-semibold">{{ conversation.name|default:"Agent" }}</h3>
        <div class="text-sm text-gray-500">Creada: {{ conversation.created_at|date:"Y-m-d H:i" }}</div>
        {% if conversation.client %}
          <div class="text-sm text-gray-600">Cliente: <strong>{{ conversation.client.name }}</strong>
            • <a class="text-blue-600 hover:underline" href="{% url 'client:detail' conversation.client.slug %}">Documentos</a>
          </div>
        {% endif %}
      </header>

      <section class="mb-4">
        <h4 class="font-medium mb-2">Prompt actual</h4>
        <div class="border rounded p-3 bg-gray-50 text-gray-800 whitespace-pre-wrap">{{ conversation.active_prompt_content|default:"(sin prompt)" }}</div>
      </section>

      <section class="mb-4">
        <form method="post" action="{% url 'agent:save_prompt' conversation.id %}">
          {% csrf_token %}
          <label class="block text-sm text-gray-600 mb-1">Prompt del agent</label>
          <textarea name="system_prompt" rows="3" class="w-full border rounded p-2" placeholder="Instrucciones del agent...">{{ conversation.active_prompt_content }}</textarea>
          <div class="mt-2 text-right">
            <button type="submit" class="btn btn-sm">Guardar prompt</button>
          </div>
        </form>
      </section>

      <section class="mb-4">
        <h4 class="font-medium mb-2">Documentos del agent</h4>
        <div class="max-h-40 overflow-y-auto border rounded mb-3">
          <ul class="divide-y">
            {% for doc in conversation.documents.all %}
              <li class="py-2 px-2 flex items-center justify-between">
                <div>
                  <div class="text-sm">{{ doc.original_name|default:doc.file.name }}</div>
                  <div class="text-xs text-gray-500">{{ doc.uploaded_at|date:"Y-m-d H:i" }} · {{ doc.size }} bytes{% if doc.uploaded_by %} · por {{ doc.uploaded_by.get_full_name|default:doc.uploaded_by.email }}{% endif %}</div>
                </div>
                <a class="text-blue-600 hover:underline text-sm" href="{{ doc.file.url }}" target="_blank">Ver</a>
              </li>
            {% empty %}
              <li class="text-sm text-gray-500 py-2 px-2">Aún no hay documentos adjuntos a este agent.</li>
            {% endfor %}
          </ul>
        </div>

        <form method="post" action="{% url 'agent:upload' conversation.id %}" enctype="multipart/form-data" class="flex items-center gap-2">
          {% csrf_token %}
          <input type="file" name="file" class="border rounded px-2 py-1" required />
          <button type="submit" class="btn btn-sm">Subir</button>
        </form>
      </section>

  <div class="flex-1 overflow-y-auto mb-4 space-y-3 min-h-0">
        {% for msg in messages %}
          <div class="{% if msg.role == 'user' %}text-right{% else %}text-left{% endif %}">
            <div class="inline-block px-4 py-2 rounded-2xl {% if msg.role == 'user' %}bg-blue-500 text-white{% else %}bg-gray-100 text-gray-800{% endif %}">
              {{ msg.content|linebreaksbr }}
            </div>
            <div class="text-xs text-gray-400 mt-1">{{ msg.created_at|date:"H:i:s" }} • {{ msg.get_role_display }}</div>
          </div>
        {% empty %}
          <p class="text-sm text-gray-500">Aún no hay mensajes en este agent.</p>
        {% endfor %}
      </div>

      <form method="post" class="sticky bottom-0 bg-white pt-2 border-t">
        {% csrf_token %}
        <textarea name="message" rows="3" required class="w-full border rounded p-2" placeholder="Escribe tu mensaje..."></textarea>
        <div class="mt-2 flex justify-end">
          <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
      </form>
    {% else %}
      <p class="text-gray-600">Selecciona o crea un agent a la izquierda.</p>
    {% endif %}
  </section>
</div>
{% endblock %}
